

txt_A = '''
### шп┤цШО:
*  хИЖцЮРф╕ГхЕлх╣┤ч║зцИРч╗й.
*  шЗкхКичФЯцИРхИЖцЮРцКешби.
'''
txt_B = '''
### чЙИцЬмцЫ┤цЦ░:
* ###### 2022.10.1,х╝АхзЛхнжф╣аnumpyуАБpandasуАВ
* ###### 2023.2.1,хоМцИРчиЛх║Пшо╛шобя╝Мх┐Ещб╗ф╕║9ф╕кхнжчзСуАВ
* ###### 2023.4.5,чФиstreamlitхИ╢ф╜Ьф║Жф╕Аф╕кwebхдЦхг│уАВ
* ###### 2023.4.30,чммф╕АцмбщЗНхЖЩф╗гчаБя╝МшЗкщАВх║ФшЛех╣▓ф╕кхнжчзСя╝Мф╕НщЬАшжБх┐Ещб╗9ф╕кхнжчзСф║ЖуАВ
* ###### 2023.5.7,ц╖╗хКац╗СхЭЧ,чбохоЪхнжчзСхИЖцЮРчЪДцпПчПнхПВшпДф║║цХ░.
* ###### 2023.5.10,хп╣хнжчзСхРНш┐ЫшбМцОТх║П.
* ###### 2023.5.18,хп╣хИЖцЮРч╗УцЮЬш░ГчФицибцЭ┐.чПнч║зхИЖцЮРхЕичПнхПВф╕О.
* ###### 2023.5.20,шЗкхКиш░ГчФич║зцо╡цибцЭ┐хблхЕЕцХ░цНо.чПнч║зхИЖцЮРф║║цХ░хПпщАЙ.
* ###### 2023.7.29,чммф║МцмбщЗНхЖЩф╗гчаБ,щЗЗчФиф║ЖцибхЭЧхМЦ/хп╣хГПхМЦ/хЗ╜цХ░хМЦцКАцЬп.
* ###### 2024.7.7,чоАхМЦф╕Аф║Ыф╗гчаБ.
* ###### 2024.10.23,цнгх╕╕ф╜┐чФиф╕АцмбцЬИшАГ.
'''
long_text = '''
# шо╛ч╜оцЙАцЬЙхнжчзСчЪДхРНчз░хИЧшбиуАВ
xk_dic = {"шпнцЦЗ": 1, "цХ░хнж": 2, "шЛ▒шпн": 3, "чЙйчРЖ": 4, "хМЦхнж": 5, "чФЯчЙй": 6, "цФ┐ц▓╗": 7, "хОЖхП▓": 8, "хЬ░чРЖ": 9}

# шо╛ч╜охПМш╛╛цаЗхЗ╜цХ░чЪДхнжчзСцОТхРНф╕ОцА╗хИЖцОТхРН
R_XK, R_ZF = 260, 260  # хнжчзСцОТхРН,цА╗хИЖцОТхРН
# шо╛ч╜охПМш╛╛цаЗчЪДчзпхИЖхА╝
JF_SDB = [7.5]

# шо╛ч╜охнжчзСхИЖцХ░цо╡.
ls1 = [36, 48, 60, 72, 78, 84, 90, 96, 102, 108, 114, 120]  # 120хИЖцХ░цо╡
ls7 = [21, 28, 35, 42, 45, 49, 52, 56, 60, 63, 66, 70]      # 70хИЖцХ░цо╡
ls5 = [15, 20, 25, 30, 32, 35, 37, 40, 42, 45, 48, 50]      # 50хИЖцХ░цо╡
# шо╛ч╜охнжчзСхИЖцХ░цо╡чЪДчзпхИЖхА╝.
JF_FSD = [1, 2, 3, 5, 5.5, 6, 6.5, 7.5, 8, 9, 9.5, 10]       # цпПф╕кхИЖцХ░цо╡чЪДчзпхИЖхА╝

# шо╛ч╜очПнч║зхРНцмбцо╡
MC_BJ = [0, 10, 50, 100, 150, 200, 250, 300, 350, 400]      # хРДф╕кхРНцмбцо╡
# шо╛ч╜очПнч║зхРНцмбцо╡чЪДчзпхИЖхА╝
JF_BJ = [10, 9.5, 9, 8.5, 8, 7, 6, 2, 2, 0]                  # хРДф╕кхРНцмбцо╡чЪДчзпхИЖ

# цИРч╗йцКешбичЪДxlsxцЦЗф╗╢.
MB_file = "c:/loongsea/цибцЭ┐2024.xlsx"

'''
from longsea.als import workbook_to_bytesIO
from longsea import als
from openpyxl import load_workbook
import streamlit as st
import pandas as pd
from io import BytesIO
import functools
import time
import os

# ----------------------------------------------------------------------------------------------------------------------
# шо╛ч╜охПВцХ░ф┐бцБп
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# шо╛ч╜оцЙАцЬЙхнжчзСчЪДхРНчз░хИЧшбиуАВ
xk_dic = {"шпнцЦЗ": 1, "цХ░хнж": 2, "шЛ▒шпн": 3, "чЙйчРЖ": 4, "хМЦхнж": 5, "чФЯчЙй": 6, "цФ┐ц▓╗": 7, "хОЖхП▓": 8, "хЬ░чРЖ": 9}

# шо╛ч╜охПМш╛╛цаЗхЗ╜цХ░чЪДхнжчзСцОТхРНф╕ОцА╗хИЖцОТхРН
R_XK, R_ZF = 260, 260  # хнжчзСцОТхРН,цА╗хИЖцОТхРН
# шо╛ч╜охПМш╛╛цаЗчЪДчзпхИЖхА╝
JF_SDB = [7.5]

# шо╛ч╜охнжчзСхИЖцХ░цо╡.
ls1 = [36, 48, 60, 72, 78, 84, 90, 96, 102, 108, 114, 120]  # 120хИЖцХ░цо╡
ls7 = [21, 28, 35, 42, 45, 49, 52, 56, 60, 63, 66, 70]      # 70хИЖцХ░цо╡
ls5 = [15, 20, 25, 30, 32, 35, 37, 40, 42, 45, 48, 50]      # 50хИЖцХ░цо╡
# шо╛ч╜охнжчзСхИЖцХ░цо╡чЪДчзпхИЖхА╝.
JF_FSD = [1, 2, 3, 5, 5.5, 6, 6.5, 7.5, 8, 9, 9.5, 10]       # цпПф╕кхИЖцХ░цо╡чЪДчзпхИЖхА╝

# шо╛ч╜очПнч║зхРНцмбцо╡
MC_BJ = [0, 10, 50, 100, 150, 200, 250, 300, 350, 400]      # хРДф╕кхРНцмбцо╡
# шо╛ч╜очПнч║зхРНцмбцо╡чЪДчзпхИЖхА╝
JF_BJ = [10, 9.5, 9, 8.5, 8, 7, 6, 2, 2, 0]                  # хРДф╕кхРНцмбцо╡чЪДчзпхИЖ

# цИРч╗йцКешбичЪДxlsxцЦЗф╗╢.
MB_file = "c:/loongsea/цибцЭ┐2024.xlsx"
# MB_file = "./цибцЭ┐2024.xlsx"

# ----------------------------------------------------------------------------------------------------------------------
# шо╛ч╜ощб╡щЭвф┐бцБп
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# шо╛ч╜оч╜Сщб╡цШ╛чд║ф┐бцБп
st.set_page_config(page_title="цИРч╗йхИЖцЮР_LOONGSEA", page_icon=":bar_chart:",initial_sidebar_state="expanded",)
# цШ╛чд║ф╕╗цаЗщвШ
st.markdown(''' ### цИРч╗йхИЖцЮРчиЛх║П ''')
st.write("***")
# ц╖╗хКаф╛зш╛╣цаПшп┤цШОцЦЗцЬм
st.sidebar.write(txt_A)

# хИЫх╗║ф╕Аф╕кф╕Кф╝ацЦЗф╗╢чЪДцМЙщТо
uploaded_file = st.file_uploader("ф╕Кф╝аXLSXцЦЗф╗╢", type=["xlsx"])
if not uploaded_file:
    st.text_area(label='шо╛ч╜ошп┤цШО', value=long_text, height=570, help=txt_B)
    exit()
elif uploaded_file:
    # ц╖╗хКаф╕дф╕кхИЖхИЧ.
    col_A, col_B = st.columns(2)
    # х╖жхИЖхИЧ
    with col_A:
        # ф╜┐чФиPandasшп╗хПЦх╖▒ф╕Кф╝ачЪДExcelцЦЗф╗╢
        df = pd.read_excel(uploaded_file, engine='openpyxl', sheet_name=None)      # шп╗хПЦцЙАцЬЙх╖еф╜ЬшбиуАВ
        # хИЫх╗║ф╕Аф╕кщАЙцЛйцбЖя╝Мш┐ФхЫЮхИЧшбиф╕нчЪДф╕Аф╕кщАЙф╕нчЪДх╖еф╜ЬшбиуАВdf.keys(),dfчЪДцЙАцЬЙх╖еф╜ЬшбихРНхИЧшби
        selected_sheet = st.selectbox("щАЙцЛйх╖еф╜Ьшби", list(df.keys()))
        # х░ЖцЙАщАЙх╖еф╜ЬшбичЪДцХ░цНош┐ФхЫЮdfшбиуАВ
        df = df[selected_sheet]                          # *****************dfшбиф╕║цЙАщАЙх╖еф╜ЬшбихнжчФЯцИРч╗йшби***********************
        # ц╖╗хКаф╕Аф╕кц╗СхКицЭб,чФиф║ОщАЙцЛйч╗ЯшобхнжчзСцИРч╗йцЧ╢,шобчоЧчЪДчПнч║зхнжчФЯцХ░.
        bc_xk = st.slider('щАЙцЛйхнжчзСхИЖцЮРшМГхЫ┤', min_value=1, max_value=60, value=45)
        # хП│хИЖхИЧ:
    with col_B:
        # шп╗хПЦцибцЭ┐цЦЗф╗╢
        df_MB = pd.read_excel(MB_file, engine='openpyxl', sheet_name=None)
        # хИЫх╗║щАЙцЛйцбЖя╝Мш┐ФхЫЮхЕ╢ф╕нщАЙф╕нчЪДх╖еф╜ЬшбиуАВ
        sht_MB_name = st.selectbox("щАЙцЛйцКешбицибцЭ┐", list(df_MB.keys()))
        # ц╖╗хКаф╕Аф╕кц╗СхКицЭб,чФиф║ОщАЙцЛйч╗ЯшобхнжчзСцИРч╗йцЧ╢,шобчоЧчЪДчПнч║зхнжчФЯцХ░.
        bc_bj = st.slider('щАЙцЛйчПнч║зхИЖцЮРшМГхЫ┤', min_value=1, max_value=60, value=50)


start = time.time()
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# 0:шп╗хПЦцЦЗф╗╢х╣╢хоЪф╣Йф╕║ana_dfхп╣ш▒б.
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
#  хжВцЮЬц▓бцЬЙф╕Кф╝ацЦЗф╗╢,хИЩщААхЗ║чиЛх║П.
if df.empty:
    exit()
# хжВцЯех╖▒ф╕Кф╝ацЦЗф╗╢,чФЯцИРф╕║ana_dfхп╣ш▒бdf.
df = als.ana_df(df, xk_dic=xk_dic)
# шО╖хПЦхоЮцЬЙчЪДцаЗхЗЖхнжчзСхРНчз░,хжВх┐Ещб╗ф╕║"шЛ▒шпн"чнЙ.
lst_XKM = df.get_xkm()



# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# A:шобчоЧхПМш╛╛цаЗф║║цХ░,чФЯцИРхПМш╛╛цаЗцКешби.чЫоцаЗхп╣ш▒б:df_MC,ч╗УцЮЬхп╣ш▒б:df_SDB(хПМш╛╛цаЗцКешби)
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# шО╖хПЦхнжчзСцА╗хИЖхРНцмбшби,хНХхЕГца╝хА╝ф╕║хнжчзСхРНцмбф╕ОцА╗хИЖхРНцмбч╗ДцИРчЪДхЕГч╗Д.
df_MC = df.get_mc(banc=bc_xk)

# ф╗ОхЗ╜цХ░als.ana_sdbхоЪф╣ЙхБПхЗ╜цХ░SDB_Aя╝Мшо╛ч╜охнжчзСцОТхРНxk=200,цА╗хИЖцОТхРНzf=200.
SDB_A = functools.partial(als.Fun_sdb, xk=R_XK, zf=R_ZF)
# хИЫх╗║хнЧхЕ╕я╝МщФохА╝хп╣ф╕║{"цА╗хИЖ":'count'},ч╗ЯшобцА╗хИЖчЪДф╕кцХ░,ф╗ех╛ЧхИ░хПВшпДф║║цХ░уАВ
dic_XKZF = {"цА╗хИЖ": 'count'}
# цЫ┤цЦ░хнЧхЕ╕я╝Мц╖╗хКащФохА╝хп╣ф╕║{хнжчзСхРНя╝ЪхПМш╛╛цаЗхЗ╜цХ░},ф╗ешобчоЧхПМш╛╛цаЗф║║цХ░.
dic_XKZF.update({str(i): SDB_A for i in lst_XKM})    # {"цА╗хИЖ": 'count', "шпнцЦЗ": SDB_A .......})
# ф╜┐чФишБЪхРИхЗ╜цХ░,чбохоЪхПВшпДф║║цХ░хТМхПМш╛╛цаЗф║║цХ░.
df_SDB = df_MC.groupby("чПнч║з").agg(dic_XKZF)          # чнЙф╗╖ф║О.agg({"цА╗хИЖ": 'count', "шпнцЦЗ": SDB_A .......})
# цЬАч╗ИцИРцЮЬ:df_SDB.


# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# B1:хИЖцХ░цо╡ч╗Яшобф╕Оф╕дчОЗф╕Ах╣│.чЫоцаЗхп╣ш▒б:df_FSD,ч╗УцЮЬхп╣ш▒б:dfs_xk(хРДхнжчзСчЪДхИЖцХ░цо╡ф╕Оф╕дчОЗф╕Ах╣│цКешбичЪДхИЧшби)
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# хп╣хЗ╜цХ░als.GFuns_fsd(хИЖч▒╗цо╡хЗ╜цХ░)хоЪф╣ЙхБПхЗ╜цХ░,хИЖхИлхп╣х║Ф120,70,50ф╕ЙчзНхнжчзС.ls1,ls7,ls5чЪДхА╝хЬицЬАхЙНчЪДшо╛ч╜оф╕нф┐оцФ╣.
Fsds1 = functools.partial(als.GFuns_fsd, ls=ls1)()  # шо╛ч╜охБПхЗ╜цХ░х╣╢ш┐РшбМ,х╛ЧхИ░ф╕Аф╕кч╗Яшоб120хИЖхА╝хнжчзСчЪДхЗ╜цХ░ч╗Д.
Fsds7 = functools.partial(als.GFuns_fsd, ls=ls7)()  # шо╛ч╜охБПхЗ╜цХ░х╣╢ш┐РшбМ,х╛ЧхИ░ф╕Аф╕кч╗Яшоб70хИЖхА╝хнжчзСчЪДхЗ╜цХ░ч╗Д.
Fsds5 = functools.partial(als.GFuns_fsd, ls=ls5)()  # шо╛ч╜охБПхЗ╜цХ░х╣╢ш┐РшбМ,х╛ЧхИ░ф╕Аф╕кч╗Яшоб50хИЖхА╝хнжчзСчЪДхЗ╜цХ░ч╗Д.

# хп╣хЗ╜цХ░als.GFuns_lv(хПКца╝чОЗф╕Оф╝ШчзАчОЗхЗ╜цХ░)шо╛ч╜охБПхЗ╜цХ░,хИЖхИлхп╣х║Ф120,70,50ф╕ЙчзНхнжчзС.
Lvs1 = functools.partial(als.GFuns_lv, ls=[72, 96, 120])()  # шо╛ч╜охБПхЗ╜цХ░х╣╢ш┐РшбМ,х╛ЧхИ░120хнжчзСчЪДхПКца╝ф╝ШчзАф║║цХ░ф╕ОцпФчОЗ.
Lvs7 = functools.partial(als.GFuns_lv, ls=[42, 56, 70])()  # шо╛ч╜охБПхЗ╜цХ░х╣╢ш┐РшбМ,х╛ЧхИ░70хнжчзСчЪДхПКца╝ф╝ШчзАф║║цХ░ф╕ОцпФчОЗ.
Lvs5 = functools.partial(als.GFuns_lv, ls=[30, 40, 50])()  # шо╛ч╜охБПхЗ╜цХ░х╣╢ш┐РшбМ,х╛ЧхИ░50хнжчзСчЪДхПКца╝ф╝ШчзАф║║цХ░ф╕ОцпФчОЗ.

# х░ЖхИЖцХ░цо╡хЗ╜цХ░уАБф╕дчОЗхЗ╜цХ░уАБх╣│хЭЗхИЖхЗ╜цХ░цНЖч╗Сф╕║цЦ╣цбИуАВ
Fan1 = [*Fsds1, *Lvs1, "mean"]  # 120хИЖцЦ╣цбИ
Fan7 = [*Fsds7, *Lvs7, "mean"]  # 70хИЖцЦ╣цбИ
Fan5 = [*Fsds5, *Lvs5, "mean"]  # 50хИЖцЦ╣цбИ
# цаЗхЗЖхнжчзСхРНф╕ОхМ╣щЕНцЦ╣цбИ
DFan = {"шпнцЦЗ": Fan1, "цХ░хнж": Fan1, "шЛ▒шпн": Fan1, "чЙйчРЖ": Fan7, "цФ┐ц▓╗": Fan7, "хМЦхнж": Fan5, "чФЯчЙй": Fan5, "хОЖхП▓": Fan5, "хЬ░чРЖ": Fan5}
# хоЮцЬЙхнжчзСхРНф╕ОхМ╣щЕНцЦ╣цбИ(цОТщЩдф║Жф╕НхнШхЬичЪДхнжчзСхРН)
dic_FSD = {i: DFan[i] for i in lst_XKM}

# шО╖хПЦф╕Аф╕кхИЖцХ░цо╡шбиdf_FSDя╝МхМЕцЛмчПнч║зя╝МхТМхРДф╕кхнжчзСчЪДхИЖхА╝уАВ
df_FSD = df.get_df(bas=["чПнч║з"], banc=bc_xk)
# цМЙчПнч║зхИЖч╗ДхРОя╝МцЙзшбМхИЖцХ░ч╗ДхЗ╜цХ░ф╕Оф╕дчОЗф╕Ах╣│шобчоЧуАВчФЯцИРф╕Аф╕кцКешби.
df_FSD = df_FSD.groupby("чПнч║з").agg(dic_FSD)
# цМЙхИЧцаЗ(хнжчзС)цЛЖхИЖхИЖцХ░цо╡хИЖцЮРшбиф╕║хдЪф╕кхнжчзСчЪДхИЖцЮРцКешби,чД╢хРОч╗ДцИРф╕Аф╕кхИЧшбиlist_xk.
dfs_xk = als.df_split(df_FSD)

# st.write(dfs_xk[0])
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# B2:ф╕║хИЖцХ░цо╡ф╕дчОЗф╕Ах╣│шбиц╖╗хКачзпхИЖхИЧ/цОТхРНхИЧ.чЫоцаЗхп╣ш▒б:dfs_xk,ч╗УцЮЬхп╣ш▒б:dfs_xk.
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# хПМш╛╛цаЗчзпхИЖшби+хИЖцХ░цо╡чЪДчзпхИЖшби
JF_FSD_SDB = JF_SDB + JF_FSD
# ф╕║чзпхИЖхЗ╜цХ░шо╛ч╜охБПхе╜хА╝,х░ЖчзпхИЖцЭГщЗНхА╝хЕИшбМхКахЕе.
JF = functools.partial(als.Fun_jf, qz=JF_FSD_SDB)  # шо╛ч╜охБПхЗ╜цХ░,щвДхЕИшо╛ч╜оqzчЪДхА╝ф╕║JF_FSD_SDB.

# ф╕║хнжчзСхИЖцЮРцКешбичЪДцпПф╕кхнжчзСцКешбиц╖╗хКацЦ░хИЧ.
for xkm, dff in zip(lst_XKM, dfs_xk):
    # ц╖╗хКахПМш╛╛цаЗхИЧ.
    dff.insert(loc=0, column=('ч╗Яшоб', "хПМш╛╛цаЗ"), value=df_SDB[xkm])
    # ц╖╗хКачзпхИЖхИЧ
    dff.insert(loc=0, column=('ч╗Яшоб', "чзпхИЖ"), value=dff.iloc[:, 0:(len(JF_FSD_SDB))].apply(JF, axis=1))
    # ц╖╗хКацОТхРНхИЧ.
    dff.insert(loc=1, column=('ч╗Яшоб', "цОТхРН"), value=dff[("ч╗Яшоб", "чзпхИЖ")].rank(axis=0, ascending=False, method="min"))
    # ц╖╗хКахПВшпДф║║цХ░хИЧ
    dff.insert(loc=0, column=('ч╗Яшоб', "ф║║цХ░"), value=df_SDB["цА╗хИЖ"])


# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# C:шобчоЧчПнч║зцИРч╗й,ч╗ЯшобчПнч║зхРНцмбцо╡цГЕхЖ╡.чЫоцаЗхп╣ш▒б:df_BJ.ч╗УцЮЬхп╣ш▒б:df_BJ.
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# ф╕║хРНцмбцо╡хЗ╜цХ░шо╛ч╜охБПхЗ╜цХ░х╣╢ш┐РшбМ(ч╝║чЬБхА╝ф╕║хРНцмбшби,ф╕Нч┤пшобшобцХ░),чФЯцИРч╗ЯшобхРНцмбцо╡чЪДхЗ╜цХ░ч╗ДчЪДхИЧшби.
MC_FunS_0 = functools.partial(als.GFunS_mcd, ls=MC_BJ, lj=0)()  # шо╛ч╜охБПхЗ╜цХ░,ф╕Нч┤пшобшобцХ░.
MC_FunS_1 = functools.partial(als.GFunS_mcd, ls=MC_BJ, lj=1)()  # шо╛ч╜охБПхЗ╜цХ░,ч┤пшобшобцХ░.
# ф╕║чзпхИЖхЗ╜цХ░шо╛ч╜охБПхе╜хА╝ч╜оф╕║чПнч║зчзпхИЖшби:JF_b
BJF = functools.partial(als.Fun_jf, qz=JF_BJ)

# хИЫх╗║чПнч║зшбия╝МхПкхМЕцЛмчПнч║зхИЧф╕ОцА╗хИЖхИЧя╝МчПнч║зчФицЭехИЖч╗Дя╝МцА╗хИЖчФицЭех║ФчФихРНцмбцо╡хЗ╜цХ░уАВ
df_BJ = df.get_df(bas=["чПнч║з"], xk=0, count=["ч║зцмб"], banc=bc_bj)  # хМЕцЛмчПнч║зхИЧ/хнжчзСхИЧ/ч║зцмбхИЧ.
# чФичПнч║зхИЖч╗Дя╝МчФицА╗хИЖх║ФчФихРНцмбцо╡хЗ╜цХ░,countхЗ╜цХ░чФиф║Оч╗ЯшобцХ░цНоцА╗ф╕кцХ░уАВ
df_BJ = df_BJ.groupby("чПнч║з")["ч║зцмб"].agg(["count", *MC_FunS_0, *MC_FunS_1])
# цПТхЕечзпхИЖхИЧуАВ
df_BJ.insert(loc=1, column="чзпхИЖ", value=df_BJ.iloc[:, 1:(len(MC_BJ) + 1)].apply(BJF, axis=1))  # ц╖╗хКачзпхИЖхИЧ
# цПТхЕехРНцмбхИЧуАВ
df_BJ.insert(loc=2, column="цОТхРН", value=df_BJ["чзпхИЖ"].rank(axis=0, ascending=False, method="min"))  # ц╖╗хКачзпхИЖцОТхРНхИЧ

# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# D:щАЙцЛйцибцЭ┐цЦЗф╗╢ws,х╣╢щТИхИЖцЮРцХ░цНоц│ихЕех╖еф╜Ьшбиwsф╕н.чЫоцаЗхп╣ш▒б:df_BJ,dfs_xk.
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# цЙУх╝АцибцЭ┐цЦЗф╗╢уАВ
wb = load_workbook(MB_file)  # цибцЭ┐цЦЗф╗╢.
# хИащЩдцЧахЕ│х╖еф╜Ьшби,х╣╢ф┐ЭхнШх╖еф╜Ьч░┐ф╕Ох╖еф╜Ьшби,
wb,ws = als.retain_worksheet(wb,sht_MB_name)


# х░ЖчПнч║зхИЖцЮРцХ░цНоц│ихЕеwsшбиф╕нуАВ
als.dfs_to_ws(ws,133,4,[df_BJ])
# х░ЖхнжчзСхИЖцЮРшбичЪДхИЧшбиц│ихЕеwsшби.
als.dfs_to_ws(ws,5,4,dfs_xk,16,0)
# х░Жwbх░БшгЕф╕║ф╕Аф╕кф║Мш┐ЫшбМчЪДBytisIOцЦЗф╗╢.
down_file=workbook_to_bytesIO(wb)

# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# E:ц╖╗хКаф╕Аф╕кф╕Лш╜╜цМЙщТо
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# ц╖╗хКацЧ╢щЧ┤ф┐бцБпуАВ
st.success(f"ш┐РчоЧх╖▒ч╗ПхоМцИРя╝МхЕ▒чФицЧ╢я╝Ъ{round(time.time() - start, 2)}чзТуАВ")
# хИЫх╗║ф╕Лш╜╜цМЙщТо,ф╗еф╛┐ф╕Лш╜╜цндх╖еф╜Ьч░┐
st.download_button(icon = "ЁЯУЬ",
    label='ф╕Лш╜╜хИЖцЮРч╗УцЮЬ',
    data=down_file,
    file_name=os.path.splitext(uploaded_file.name)[0] + "_" + sht_MB_name + "_цКешби" + ".xlsx",
    mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')