from longsea import al
from openpyxl import load_workbook
import streamlit as st
import pandas as pd
import time
import os
from longsea import al2
from longsea.al2 import wb_to_bytesIO, df_sort, validate_dataframe

txt_A = '''
### шп┤цШО:
*  ф╕ГхЕлх╣┤ч║зхИЖцЮР.
*  al2.2025.9.26.
'''
txt_B = '''
### чЙИцЬмцЫ┤цЦ░:
* ###### 2022.10.1,х╝АхзЛхнжф╣аnumpyуАБpandasуАВ
* ###### 2023.2.1,хоМцИРчиЛх║Пшо╛шобя╝Мх┐Ещб╗ф╕║9ф╕кхнжчзСуАВ
* ###### 2023.4.5,чФиstreamlitхИ╢ф╜Ьф║Жф╕Аф╕кwebхдЦхг│уАВ
* ###### 2023.4.30,чммф╕АцмбщЗНхЖЩф╗гчаБя╝МшЗкщАВх║ФшЛех╣▓ф╕кхнжчзСуАВ
* ###### 2023.5.7-5.20,ц╖╗хКац╗СхЭЧ,ш░ГчФицибцЭ┐.
* ###### 2023.7.29,чммф║МцмбщЗНхЖЩф╗гчаБ,хИЫх╗║alsцибхЭЧ.
* ###### 2024.7.7-10.23,чоАхМЦф╕Аф║Ыф╗гчаБ.хп╣ф╣Эх╣┤ч║зщЗЗчФицЦ░хИЖцЮРцЦ╣ц│ХуАВ
* ###### 2024.11.14-23,цККalsщЗНцЮДф╕║alуАВ
* ###### 2025.9.21-928,цККalщЗНцЮДф╕║al2.
'''
long_text = '''
# =============================хИЖцХ░цо╡_ш╛╛цаЗцКешби================================
# {хИЖцХ░цо╡я╝ЪхнжчзС}хнЧхЕ╕.
dic_fsd = {(36, 48, 60, 72, 78, 84, 90, 96, 102, 108, 114, 120): ["шпнцЦЗ", "цХ░хнж", "шЛ▒шпн"],
           (21, 28, 35, 42, 45, 49, 52, 56, 60, 63, 66, 70): ["чЙйчРЖ", "цФ┐ц▓╗"],
           (15, 20, 25, 30, 32, 35, 37, 40, 42, 45, 48, 50): ["хМЦхнж","чФЯчЙй", "хОЖхП▓", "хЬ░чРЖ"]}
# цпПф╕кхИЖцХ░цо╡чЪДцЭГщЗНчзпхИЖя╝МхЕ╢ф╕нчммф╕Аф╕кф╕║хПМш╛╛цаЗчзпхИЖ
fsd_thresh_score = [1,2,3,4,5,6,7,8,9,10,11,12,13]
# шо╛ч╜охнжчзСш╛╛цаЗхРНцмбя╝Ъ
max_subject_rank = 260
# шо╛ч╜оцА╗хИЖш╛╛цаЗхРНцмбя╝Ъ
max_total_rank = 260

# =============================ф╕дчОЗф╕Ах╣│цКешби===============================
# {цА╗хИЖя╝ЪхнжчзС}хнЧхЕ╕
dic_lv = {120: ["шпнцЦЗ", "цХ░хнж", "шЛ▒шпн"],
          70: ["чЙйчРЖ", "цФ┐ц▓╗"],
          50: ["хМЦхнж", "чФЯчЙй", "хОЖхП▓", "хЬ░чРЖ"]}
# чПнч║зхПВшпДф║║цХ░чФ▒ц╗СхКицЭбцОзхИ╢:max_sbj_cls_rankуАВ

# =============================чПнч║зхИЖцЮРцКешби===============================
# чПнч║зхРНцмбцо╡щШИхА╝хИЧшби
thresh_cls = [0, 10, 50, 100, 150, 200, 260, 300, 350, 400]      # хРДф╕кхРНцмбцо╡
# чПнч║зхРНцмбцо╡щШИхА╝хИЧшбихп╣х║ФчзпхИЖ.
thresh_cls_score = [10, 10, 10, 10, 8, 6, 2, 1.5, 1, 1]          # хРДф╕кхРНцмбцо╡чЪДчзпхИЖ
# чПнч║зхПВшпДф║║цХ░чФ▒ц╗СхКицЭбцОзч╜о:max_cls_rankуАВ

'''

# цибцЭ┐ш╖пх╛Дф┐бцБп
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# ===============================цибцЭ┐xlsxцЦЗф╗╢===========================================================
# цибцЭ┐цЦЗф╗╢
MB_file = "../longsea/цибцЭ┐2024.xlsx"
script_dir = os.path.dirname(os.path.abspath(__file__))
mb_file_path = os.path.join(script_dir, MB_file)
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа

# шо╛ч╜ощб╡щЭвф┐бцБп
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
st.set_page_config(page_title="цИРч╗йхИЖцЮР2025_al2",layout="centered", page_icon=":bar_chart:",initial_sidebar_state="expanded",)
# цШ╛чд║ф╕╗цаЗщвШ
st.markdown(''' ### ф╕ГхЕлх╣┤ч║зхИЖцЮР2025-al2 ''')
st.write("***")
# ц╖╗хКаф╛зш╛╣цаПшп┤цШОцЦЗцЬм
st.sidebar.write(txt_A)

# шо╛ч╜оф║дф║ТцОзф╗╢
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# хИЫх╗║ф╕Аф╕кф╕Кф╝ацЦЗф╗╢чЪДцМЙщТо
uploaded_file = st.file_uploader("ф╕Кф╝аXLSXцЦЗф╗╢", type=["xlsx"])

# цПРчд║ф╕Кф╝ацЦЗф╗╢
if not uploaded_file:
    st.text_area(label='шо╛ч╜ошп┤цШО',value=long_text,height=400)
    exit()
elif uploaded_file:
    col_A, col_B = st.columns(2)
    with col_A:
        dic_df = pd.read_excel(uploaded_file, engine='openpyxl', sheet_name=None)       # шп╗хПЦцЙАцЬЙх╖еф╜ЬшбиуАВ
        selected_sheet_name = st.selectbox("щАЙцЛйх╖еф╜Ьшби", list(dic_df.keys()))
        df = dic_df[selected_sheet_name]
        # ц╖╗хКаф╕Аф╕кц╗СхКицЭб,чФиф║ОщАЙцЛйч╗ЯшобхнжчзСцИРч╗йцЧ╢,шобчоЧчЪДчПнч║зхнжчФЯцХ░.
        max_sbj_cls_rank = st.slider('ф╕дчОЗф╕Ах╣│хПВшпДф║║цХ░', min_value=1, max_value=60, value=45)
    with  col_B:
        try:
            dic_mb_df = pd.read_excel(mb_file_path, engine='openpyxl', sheet_name=None)
            sht_MB_name = st.selectbox("щАЙцЛйцибцЭ┐", list(dic_mb_df.keys()))
            mb_df = dic_mb_df[sht_MB_name]
        except FileNotFoundError:
            st.error("цЙ╛ф╕НхИ░ test.xlsx цЦЗф╗╢я╝Мшп╖чбоф┐ЭцЦЗф╗╢хнШхЬиф║Ох╜УхЙНчЫох╜Хф╕н")
        except Exception as e:
            st.error(f"шп╗хПЦцЦЗф╗╢цЧ╢хПСчФЯщФЩшпп: {str(e)}")
        # ц╖╗хКаф╕Аф╕кц╗СхКицЭб,чФиф║ОщАЙцЛйч╗ЯшобхнжчзСцИРч╗йцЧ╢,шобчоЧчЪДчПнч║зхнжчФЯцХ░.
        max_cls_rank = st.slider('чПнч║зхИЖцЮРхПВшпДф║║цХ░', min_value=1, max_value=60, value=50)


    # тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
    if st.checkbox("цгАцЯе/цШ╛чд║цХ░цНо"):
        vdf = validate_dataframe( df, required_columns=['чПнч║з', 'хзУхРН', 'хнжхП╖'], allow_extra_columns=False)
        st.dataframe(vdf,use_container_width= True)
        adf = al2.Andf(df)
    else:
        st.dataframe(df.head(2),use_container_width= True)
        adf = al2.Andf(df)


start = time.time()
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа   шО╖хПЦхИЖцХ░цо╡_цКешби(fsd_db_dfs)     тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# {хИЖцХ░цо╡я╝ЪхнжчзС}хнЧхЕ╕.
dic_fsd = {(48, 60, 72, 84, 96, 108, 120): ["шпнцЦЗ", "цХ░хнж", "шЛ▒шпн"],
           (28, 35, 42, 49, 56, 63, 70): ["чЙйчРЖ", "цФ┐ц▓╗"],
           (20, 25, 30, 35, 40, 45, 50): ["хМЦхнж","чФЯчЙй", "хОЖхП▓", "хЬ░чРЖ"]}
# цпПф╕кхИЖцХ░цо╡чЪДцЭГщЗНчзпхИЖя╝М
fsd_thresh_score = [1,2,6,7,7,7,7]

# шО╖хПЦхИЖцХ░цо╡_ш╛╛цаЗцКешби
fsd_dfs = adf.get_fsd(dic_thresh_sbj = dic_fsd,
                      thresh_score = fsd_thresh_score,  )


# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа   шО╖хПЦф╕дчОЗф╕Ах╣│цКешбия╝Иlv_dfsя╝Й     тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# {цА╗хИЖя╝ЪхнжчзС}хнЧхЕ╕
dic_lv = {120: ["шпнцЦЗ", "цХ░хнж", "шЛ▒шпн"],
          70: ["чЙйчРЖ", "цФ┐ц▓╗"],
          50: ["хМЦхнж", "чФЯчЙй", "хОЖхП▓", "хЬ░чРЖ"]}
# чПнч║зхПВшпДф║║цХ░чФ▒ц╗СхКицЭбцОзхИ╢:max_sbj_cls_rankуАВ

# шО╖хПЦф╕дчОЗф╕Ах╣│цКешби
lv_dfs = adf.get_lv(
    dic_total_sbj = dic_lv,
    max_class_rank=max_sbj_cls_rank,
    include_count_valid=1,
    add_rank_cols=[2,4,5],    )

# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа   шО╖хПЦчПнч║зхИЖцЮРцКешбия╝Иbj_dfsя╝Й     тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# чПнч║зхРНцмбцо╡щШИхА╝хИЧшби
thresh_cls = [0, 10, 50, 100, 150, 200, 260, 300, 350, 400]      # хРДф╕кхРНцмбцо╡
# чПнч║зхРНцмбцо╡щШИхА╝хИЧшбихп╣х║ФчзпхИЖ.
thresh_cls_score = [10, 10, 10, 10, 8, 6, 2, 1.5, 1, 1]          # хРДф╕кхРНцмбцо╡чЪДчзпхИЖ
# чПнч║зхПВшпДф║║цХ░чФ▒ц╗СхКицЭбцОзч╜о:max_cls_rankуАВ

bj1_dfs = adf.get_cls(thresh=thresh_cls,
                     thresh_score=thresh_cls_score,
                     max_class_rank=max_cls_rank)
bj0_dfs = adf.get_cls(thresh=thresh_cls,
                     thresh_score=None,
                     max_class_rank=max_cls_rank,
                     cumu=1     )

# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# B:щАЙцЛйцибцЭ┐цЦЗф╗╢ws,х░ЖхИЖцЮРцКешбиц│ихЕех╖еф╜Ьшбиwsф╕н.
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# цЙУх╝АцибцЭ┐цЦЗф╗╢уАВ
wb = load_workbook(mb_file_path)  # цибцЭ┐цЦЗф╗╢.
# ц╕Ец┤Чх╖еф╜Ьч░┐wb,ф┐ЭхнШх╖еф╜Ьч░┐wbф╕ОцибцЭ┐х╖еф╜Ьшбиws,
wb,ws = al.trim_wb(wb,sht_MB_name)

# х░ЖхРДч▒╗цКешбицХ░цНоц│ихЕех╖еф╜Ьшби
# хИЖцХ░цо╡цКешби
al2.dfs_to_ws(ws, 5, 4, list(fsd_dfs.values()), 16, 0, False, idx=False)
# ф╕дчОЗф╕Ах╣│цКешби
al2.dfs_to_ws(ws, 5, 14, list(lv_dfs.values()), 16, 0, False, idx=False)
# чПнч║зхИЖцЮРцКешби(чзпхИЖчЙИ)
al2.dfs_to_ws(ws, 149, 4, bj1_dfs, 16, 0, False, idx=False)
# чПнч║зхИЖцЮРцКешби(ч┤пшобчЙИ)
al2.dfs_to_ws(ws, 149, 17, bj0_dfs, 16, 0, False, idx=False)

# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# C:щАЙцЛйцибцЭ┐,хИЫх╗║х╖еф╜Ьшби,х░ЖцИРч╗йшбиуАБхРНцмбшбиц│ихЕех╖еф╜ЬшЦДф╕н.
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# хЬицибцЭ┐цЦЗф╗╢ф╕нцЦ░х╗║хРНцмбшбиws1.
ws1 = wb.create_sheet("хРНцмбшби",1)
# шО╖хПЦхРНцмбшби,х╣╢х░ЖцХ░цНоц│ихЕеws1шбиф╕нуАВ
df_MC0 = adf.get_mc(combine_ranks=0)
df_MC0 = df_sort(df_MC0,cols=['чПнч║з','хнжхП╖','хзУхРН',"шпнцЦЗ","цХ░хнж","шЛ▒шпн"],sort_by = ["чПнч║з","ч║зцмб"])
al2.dfs_to_ws(ws1,1,1,df_MC0,hd=True)

# ==============================================================================================
# хЬицибцЭ┐цЦЗф╗╢ф╕нцЦ░х╗║цИРч╗йшбиws2.
ws2 = wb.create_sheet("цИРч╗йшби",1)
# шО╖хПЦхРНцмбшби,х╣╢х░ЖцХ░цНоц│ихЕеws1шбиф╕нуАВ
df_all = adf.get_all()
df_all = df_sort(df_all,cols=['чПнч║з','хнжхП╖','хзУхРН',"шпнцЦЗ","цХ░хнж","шЛ▒шпн"],sort_by = ["чПнч║з","ч║зцмб"])
al2.dfs_to_ws(ws2,1,1,df_all,hd=True)


# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# C:ц╖╗хКаф╕Аф╕кф╕Лш╜╜цМЙщТо
# тЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦатЦа
# ц╖╗хКацЧ╢щЧ┤ф┐бцБпуАВ
st.success(f"ш┐РчоЧх╖▒ч╗ПхоМцИРя╝МхЕ▒чФицЧ╢я╝Ъ{round(time.time() - start, 2)}чзТуАВ")
# хИЫх╗║ф╕Лш╜╜цМЙщТо,ф╗еф╛┐ф╕Лш╜╜цндх╖еф╜Ьч░┐
st.download_button(
    label='ЁЯУеф╕Лш╜╜хИЖцЮРч╗УцЮЬ',
    type= 'primary',
    data=wb_to_bytesIO(wb),
    file_name=os.path.splitext(uploaded_file.name)[0] + "_" + sht_MB_name + "_цКешби" + ".xlsx",
    mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')

